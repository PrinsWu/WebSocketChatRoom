// for local test data
var testnameresult = {
    "tests" : [
        {
            "id" : "001",
            "test_name" : "I03_1_homepage"
        },
        {
            "id" : "002",
            "test_name" : "I04_2_search0201"
        },
        {
            "id" : "003",
            "test_name" : "I05_3_search0301"
        },
        {
            "id" : "004",
            "test_name" : "I23_3_mix_100vu"
        }
    ]
};
var _result = {
    "tdatas" : [
        {
            "date" : "2018/10/07",
            "tests" : [
                {
                    "id" : "001",
                    "type" : "1",
                    // "test_id" : "01_02",
                    // "test_no" : "0621A01",
                    "test_name" : "I03_1_homepage",
                    "test_time" : "14:25",
                    "exec_time" : "5",
                    "vuser" : "100",
                    "note" : "001\nnote\nabc\ndef\nhijkl",
                    "action_steps" : [
                        {
                            "action_step_id" : "001001",
                            "action_name" : "所有動作",
                            "total_counts" : "22154",
                            "s_counts" : "22154",
                            "f_counts" : "0",
                            "f_rate" : "0.00",
                            "avg_res_time" : "1.345",
                            "throughput" : "100.41",
                            "hit" : "379.7",
                            "avg_conns" : "529.4",
                            "type" : "all",
                            "note" : "001\nnote\nabc\ndef\nhijkl"
                        }
                    ]
                },
                {
                    "id" : "002",
                    "type" : "1",
                    // "test_id" : "01_02",
                    // "test_no" : "0621A01",
                    "test_name" : "I04_2_search0201",
                    "test_time" : "14:37",
                    "exec_time" : "5",
                    "vuser" : "200",
                    "note" : "001\nnote\nabc\ndef\nhijkl",
                    "action_steps" : [
                        {
                            "action_step_id" : "002001",
                            "action_name" : "0_開啟首頁",
                            "total_counts" : "15138",
                            "s_counts" : "15138",
                            "f_counts" : "0",
                            "f_rate" : "0.00",
                            "avg_res_time" : "1.445",
                            "throughput" : "1.41",
                            "hit" : "379.7",
                            "avg_conns" : "529.4",
                            "type" : "all",
                            "note" : "001\nnote\nabc\ndef\nhijkl"
                        },
                        {
                            "action_step_id" : "002002",
                            "action_name" : "1_報驗進度查詢",
                            "total_counts" : "15138",
                            "s_counts" : "15138",
                            "f_counts" : "0",
                            "f_rate" : "0.00",
                            "avg_res_time" : "0.117",
                            "throughput" : "1.41",
                            "hit" : "379.7",
                            "avg_conns" : "529.4",
                            "type" : "all",
                            "note" : "001\nnote\nabc\ndef\nhijkl"
                        },
                        {
                            "action_step_id" : "002003",
                            "action_name" : "2_完成查詢",
                            "total_counts" : "15138",
                            "s_counts" : "15138",
                            "f_counts" : "0",
                            "f_rate" : "0.00",
                            "avg_res_time" : "0.385",
                            "throughput" : "1.41",
                            "hit" : "379.7",
                            "avg_conns" : "529.4",
                            "type" : "all",
                            "note" : "001\nnote\nabc\ndef\nhijkl"
                        },
                        {
                            "action_step_id" : "002004",
                            "action_name" : "所有動作",
                            "total_counts" : "15138",
                            "s_counts" : "15138",
                            "f_counts" : "0",
                            "f_rate" : "1.00",
                            "avg_res_time" : "1.947",
                            "throughput" : "100.41",
                            "hit" : "379.7",
                            "avg_conns" : "529.4",
                            "type" : "all",
                            "note" : "001\nnote\nabc\ndef\nhijkl"
                        }
                    ]
                }
            ]
        },
        {
            "date" : "2018/10/10",
            "tests" : [
                {
                    "id" : "003",
                    "type" : "1",
                    // "test_id" : "01_02",
                    // "test_no" : "0621A01",
                    "test_name" : "I05_3_search0301",
                    "test_time" : "14:50",
                    "exec_time" : "5",
                    "vuser" : "100",
                    "note" : "001\nnote\nabc\ndef\nhijkl",
                    "action_steps" : [
                        {
                            "action_step_id" : "003001",
                            "action_name" : "0_開啟首頁",
                            "total_counts" : "17927",
                            "s_counts" : "17927",
                            "f_counts" : "0",
                            "f_rate" : "0.00",
                            "avg_res_time" : "1.301",
                            "throughput" : "1.41",
                            "hit" : "379.7",
                            "avg_conns" : "529.4",
                            "type" : "all",
                            "note" : "001\nnote\nabc\ndef\nhijkl"
                        },
                        {
                            "action_step_id" : "003002",
                            "action_name" : "1_單證比對結果查詢",
                            "total_counts" : "17927",
                            "s_counts" : "17927",
                            "f_counts" : "0",
                            "f_rate" : "0.00",
                            "avg_res_time" : "0.127",
                            "throughput" : "1.41",
                            "hit" : "379.7",
                            "avg_conns" : "529.4",
                            "type" : "all",
                            "note" : "001\nnote\nabc\ndef\nhijkl"
                        },
                        {
                            "action_step_id" : "003003",
                            "action_name" : "2_完成查詢",
                            "total_counts" : "17927",
                            "s_counts" : "17927",
                            "f_counts" : "0",
                            "f_rate" : "0.00",
                            "avg_res_time" : "0.218",
                            "throughput" : "1.41",
                            "hit" : "500",
                            "avg_conns" : "529.4",
                            "type" : "all",
                            "note" : "001\nnote\nabc\ndef\nhijkl"
                        },
                        {
                            "action_step_id" : "003004",
                            "action_name" : "所有動作",
                            "total_counts" : "17927",
                            "s_counts" : "17927",
                            "f_counts" : "21",
                            "f_rate" : "22.00",
                            "avg_res_time" : "1.146",
                            "throughput" : "100.41",
                            "hit" : "379.7",
                            "avg_conns" : "529.4",
                            "type" : "all",
                            "note" : "001\nnote\nabc\ndef\nhijkl"
                        }
                    ]
                },
                {
                    "id" : "004",
                    "type" : "1",
                    // "test_id" : "01_02",
                    // "test_no" : "0621A01",
                    "test_name" : "I23_3_mix_100vu",
                    "test_time" : "15:04",
                    "exec_time" : "6",
                    "vuser" : "200",
                    "note" : "001\nnote\nabc\ndef\nhijkl",
                    "action_steps" : [
                        {
                            "action_step_id" : "004001",
                            "action_name" : "0_開啟首頁",
                            "total_counts" : "17927",
                            "s_counts" : "17927",
                            "f_counts" : "0",
                            "f_rate" : "0.00",
                            "avg_res_time" : "14.317",
                            "throughput" : "1.41",
                            "hit" : "379.7",
                            "avg_conns" : "529.4",
                            "type" : "all",
                            "note" : "001\nnote\nabc\ndef\nhijkl"
                        },
                        {
                            "action_step_id" : "004002",
                            "action_name" : "1_報驗進度查詢",
                            "total_counts" : "17927",
                            "s_counts" : "17927",
                            "f_counts" : "0",
                            "f_rate" : "0.00",
                            "avg_res_time" : "1.058",
                            "throughput" : "1.41",
                            "hit" : "379.7",
                            "avg_conns" : "529.4",
                            "type" : "all",
                            "note" : "001\nnote\nabc\ndef\nhijkl"
                        },
                        {
                            "action_step_id" : "004003",
                            "action_name" : "2_單證比對結果查詢",
                            "total_counts" : "17927",
                            "s_counts" : "17927",
                            "f_counts" : "0",
                            "f_rate" : "0.00",
                            "avg_res_time" : "1.937",
                            "throughput" : "1.41",
                            "hit" : "379.7",
                            "avg_conns" : "529.4",
                            "type" : "all",
                            "note" : "001\nnote\nabc\ndef\nhijkl"
                        },
                        {
                            "action_step_id" : "004004",
                            "action_name" : "3_查驗品目查詢",
                            "total_counts" : "17927",
                            "s_counts" : "17927",
                            "f_counts" : "0",
                            "f_rate" : "0.00",
                            "avg_res_time" : "1.036",
                            "throughput" : "1.41",
                            "hit" : "379.7",
                            "avg_conns" : "529.4",
                            "type" : "all",
                            "note" : "001\nnote\nabc\ndef\nhijkl"
                        },
                        {
                            "action_step_id" : "004005",
                            "action_name" : "4_完成報驗進度查詢",
                            "total_counts" : "17927",
                            "s_counts" : "17927",
                            "f_counts" : "0",
                            "f_rate" : "0.00",
                            "avg_res_time" : "1.497",
                            "throughput" : "1.41",
                            "hit" : "379.7",
                            "avg_conns" : "529.4",
                            "type" : "all",
                            "note" : "001\nnote\nabc\ndef\nhijkl"
                        },
                        {
                            "action_step_id" : "004006",
                            "action_name" : "5_完成單證比對結果查詢",
                            "total_counts" : "17927",
                            "s_counts" : "17927",
                            "f_counts" : "0",
                            "f_rate" : "0.00",
                            "avg_res_time" : "1.524",
                            "throughput" : "1.41",
                            "hit" : "379.7",
                            "avg_conns" : "529.4",
                            "type" : "all",
                            "note" : "001\nnote\nabc\ndef\nhijkl"
                        },
                        {
                            "action_step_id" : "004007",
                            "action_name" : "6_完成查驗品目查詢",
                            "total_counts" : "17927",
                            "s_counts" : "17927",
                            "f_counts" : "0",
                            "f_rate" : "0.00",
                            "avg_res_time" : "1.539",
                            "throughput" : "1.41",
                            "hit" : "379.7",
                            "avg_conns" : "529.4",
                            "type" : "all",
                            "note" : "001\nnote\nabc\ndef\nhijkl"
                        },
                        {
                            "action_step_id" : "004008",
                            "action_name" : "7_查詢結果換頁",
                            "total_counts" : "17927",
                            "s_counts" : "17927",
                            "f_counts" : "0",
                            "f_rate" : "0.00",
                            "avg_res_time" : "1.157",
                            "throughput" : "1.41",
                            "hit" : "379.7",
                            "avg_conns" : "529.4",
                            "type" : "all",
                            "note" : "001\nnote\nabc\ndef\nhijkl"
                        },
                        {
                            "action_step_id" : "004009",
                            "action_name" : "所有動作",
                            "total_counts" : "1625",
                            "s_counts" : "1572",
                            "f_counts" : "53",
                            "f_rate" : "3.37",
                            "avg_res_time" : "16.599",
                            "throughput" : "1.41",
                            "hit" : "379.7",
                            "avg_conns" : "529.4",
                            "type" : "all",
                            "note" : "001\nnote\nabc\ndef\nhijkl"
                        }
                    ]
                }
            ]
        }
    ]
};
// --------------------- data ---------------------

// keep the current tdatas on page
var _tdatas;
var minTextareaRows = 1;
var maxTextareaRows = 10;
// css
var class_text_left = "text-left";
var class_text_center = "text-center";
var class_text_right = "text-right";
var class_export_remove = "export-remove";
var data_row_bottom_border = "1pt solid black";

// console.log(_result);

function setupResult(result) {
    _result = result;
}
/**
 * Retrive tdatas from local if isLocalTest is true, else get from AJAX call.
 */
function retriveTdatas() {
    return _result['tdatas'];
    // if (isLocalTest && _result) {
    //     return _result['tdatas'];
    // }
    // return null;
}

/**
 * Load all data from local attribute
 */
function allData(btn) {
    if (isLocalTest) {
        loadResultTable();
    } else {
        getUiTable();
    }
    displayRadioButtonStyle(btn);
}

/**
 * Load data with JSON object and keep it in local attribute.
 * This method be called by getUiTable().
 */
function loadResultTable() {
    displayResultTable(retriveTdatas());
}

/**
 * Retrive tdatas object in result and display that.
 * @param {JSON object} tdatas 
 */
function displayResultTable(tdatas) {
    // console.log("displayResultTable....");
    // keep it in temp, that can be used when sorting
    _tdatas = tdatas;
    var tbody = $("#resultTboday");
    tbody.empty();
    for (var i = 0; i < tdatas.length; i++) {
        var tdata = tdatas[i];
        // console.log(i + ":" + tdata["date"]);
        // tdata_rowspan = calDisplayRowSpanTdata(tdata);
        // var tdata_rowspan = calDisplayRowSpan(tdata, attrs, 0, forceOneAry);
        var tdata_rowspan = 1;
        var tr = $("<tr/>");
        tbody.append(tr);
        tr.append(createTd("", tdata_rowspan, class_export_remove));
        tr.append(createTd("", tdata_rowspan, class_export_remove));
        createEmptyTd(tr, 1, tdata_rowspan);
        tr.append(createTd(tdata["date"], tdata_rowspan, class_text_center));
        createEmptyTd(tr, 11, tdata_rowspan);
        tr.append(createTd("", tdata_rowspan, class_export_remove));
        setTrBorderBottom(tr);  

        var tests = tdata["tests"];
        for (var j = 0; j < tests.length; j++) {
            tr = $("<tr/>");
            tbody.append(tr);
            test = tests[j];
            // test_rowspan = calDisplayRowSpanTest(test);
            // test_rowspan = calDisplayRowSpan(test, attrs, 1, forceOneAry)
            var test_rowspan = 1;
            var tid = test["id"]
            var hidden_id = $('<input/>', {type:'hidden',id:"tid_" + tid, value:tid});
            tr.append(hidden_id);
            // tr.append(createTd(test["test_name"], test_rowspan));
            var td = createTd("", test_rowspan, class_text_center + " " + class_export_remove);
            tr.append(td);
            var checkbox = $('<input />', { type:'checkbox', name:'deleteTid', value:tid })
            td.append(checkbox);

            var source = "L";
            if (test["type"] == "2") {
                source = "J";
            }
            tr.append(createTd(source, test_rowspan, class_export_remove + " " + class_text_center));

            td = createTd("", test_rowspan);
            tr.append(td);
            var input = $("<input type='text'/>");
            td.append(input);
            input.attr("id", "tna_" + tid);
            input.attr("value", test["test_name"]);
            tr.append(createTd(test["test_time"], test_rowspan, class_text_center));
            tr.append(createTd(test["test_time"], test_rowspan, class_text_center));
            tr.append(createTd(test["exec_time"], test_rowspan, class_text_right));
            tr.append(createTd(test["vuser"], test_rowspan, class_text_right));

            var action_steps = test["action_steps"];
            for (var k = 0; k < action_steps.length; k++) {
                action_step = action_steps[k];
                if (k != 0) {
                    var tr = $("<tr/>");
                    tbody.append(tr);
                    tr.append(createTd("", tdata_rowspan, class_export_remove));
                    tr.append(createTd("", tdata_rowspan, class_export_remove));
                    createEmptyTd(tr, 5, test_rowspan);
                }
                tr.append(createTd(action_step["total_counts"], test_rowspan, class_text_right));
                tr.append(createTd(action_step["s_counts"], test_rowspan, class_text_right));
                tr.append(createTd(action_step["f_counts"], test_rowspan, class_text_right));
                tr.append(createTd(action_step["f_rate"], test_rowspan, class_text_right));
                tr.append(createTd(action_step["action_name"], test_rowspan, class_text_left));
                tr.append(createTd(action_step["avg_res_time"], test_rowspan, class_text_right));
                tr.append(createTd(action_step["throughput"], test_rowspan, class_text_right));
                tr.append(createTd(action_step["hit"], test_rowspan, class_text_right));
                // tr.append(createTd(action_step["note"], test_rowspan));
                // td = $("<td/>");
                td = createTd("", test_rowspan, class_export_remove);
                tr.append(td);
                var tarea = $("<textarea/>");
                td.append(tarea);
                var action_step_id = action_step["action_step_id"];
                tarea.attr("id", "tar_" + action_step_id);
                tarea.attr("class", "form-control");
                tarea.attr("rows", minTextareaRows);
                tarea.text(action_step["note"]);
                tarea.attr("onClick", "toggleNote(this, '" + action_step_id + "')");
                tarea.attr("data-type", action_step["type"]);
                
                if (k == action_steps.length - 1) {
                    // tr.children("td").attr("class", "border_bottom");
                    // tr.children("td").css("border-bottom", "2pt solid black");
                    setTrBorderBottom(tr);
                }
            }
        }

    }
    // refreshTooltip();
    // console.log("displayResultTable.... end");
}

/**
 * Create a td tag with text, rowspan, class.
 * @param {text in td tag} text 
 * @param {rowspan size} rowspan 
 * @param {class in the td tag} class_name 
 */
function createTd(text, rowspan, class_name) {
    var td = $("<td/>");
    td.text(text);
    if (class_name) {
        td.attr("class", class_name);
    }
    if (rowspan && rowspan > 1) {
        td.attr("rowspan", test_rowspan);
    }
    return td;
}

/**
 * Create multiples td under the tr.
 * @param {The parent tr of that tds} tr 
 * @param {How many tds be created} length 
 * @param {rowspan size} rowspan 
 */
function createEmptyTd(tr, length, rowspan) {
    for (var i = 0; i < length; i++) {
        tr.append(createTd("", rowspan));
    }
}

/**
 * Set border css on the tr.
 * @param {The tr need to set border} tr 
 */
function setTrBorderBottom(tr) {
    tr.children("td").css("border-bottom", data_row_bottom_border);
}

/**
 * filter by query parameter on tdatas from retriveTdatas()
 * @param {query button} btn
 */
function searchAndFilter(btn) {
    // if (result == undefined || result["tdatas"] == undefined) {
    //     return;
    // }
    // var tdatas = result["tdatas"];
    // var tdatas = JSON.parse(JSON.stringify(result["tdatas"]));
    var tdatas = JSON.parse(JSON.stringify(retriveTdatas()));
    var queryDateFrom = $("#queryDateFrom").val();
    var queryDateTo = $("#queryDateTo").val();
    var queryTestName = $("#queryTestName").val();
    var queryAvgResTimeFrom = $("#queryAvgResTimeFrom").val();
    var queryAvgResTimeTo = $("#queryAvgResTimeTo").val();
    var queryThroughputFrom = $("#queryThroughputFrom").val();
    var queryThroughputTo = $("#queryThroughputTo").val();
    var querySCountsFrom = $("#querySCountsFrom").val();
    var querySCountsTo = $("#querySCountsTo").val();
    // console.log("searchAndFilter 1");

    // 1. filter date range on first level
    var tdatas = $.grep(tdatas, function(tdata, i) {
        // console.log(n.tests);
        if (!compareColumn(tdata.date, queryDateFrom, queryDateTo)) {
            // console.log(i + ":" + false);
            return false;
        }
        return true;
    });
    // console.log(tdatas);
    // console.log(tdatas.length);
    // 2. filter test name on second level
    tdatas.forEach(function(tdata) {
        tdata.tests = $.grep(tdata.tests, function(test, i) {
            if (!compareColumnLike(test.test_name, queryTestName)) {
                return false;
            }
            return true;
        });
    });
    // 3. filter avg_res_time, s_counts on third level
    tdatas.forEach(function(tdata) {
        // tdata.tests.forEach(function(test) {
        tdata.tests = $.grep(tdata.tests, function(test) {
            var beforeSize = test.action_steps.length;
            var temp_action_steps = $.grep(test.action_steps, function(action_step) {
                if (action_step.action_name == all_action_step_name) {
                    return compareColumn(action_step.avg_res_time, queryAvgResTimeFrom, queryAvgResTimeTo, parseFloat) &&
                        compareColumn(action_step.throughput, queryThroughputFrom, queryThroughputTo, parseFloat) &&
                        compareColumn(action_step.s_counts, querySCountsFrom, querySCountsTo, parseFloat);
                }
                return true;
            });
            var afterSize = temp_action_steps.length;
            console.log("beforeSize:" + beforeSize + " afterSize:" + afterSize);
            return beforeSize == afterSize;
        });
    });
    // tdatas.forEach(function(tdata) {
    //     tdata.tests.forEach(function(test) {
    //         test.action_steps = $.grep(test.action_steps, function(action_step, i) {
    //             if (!compareColumn(action_step.avg_res_time, queryAvgResTimeFrom, queryAvgResTimeTo, parseFloat)) {
    //                 return false;
    //             }
    //             // if (!compareColumn(action_step.throughput, queryThroughputFrom, queryThroughputTo)) {
    //             //     return false;
    //             // }
    //             if (!compareColumn(action_step.s_counts, querySCountsFrom, querySCountsTo, parseFloat)) {
    //                 return false;
    //             }
    //             return true;
    //         });
    //     });
    // });
    // console.log("searchAndFilter 2");
    // 4. remove the test if the action_steps of it is empty
    // tdatas.forEach(function(tdata) {
    //     tdata.tests = $.grep(tdata.tests, function(test, i) {
    //         if (!test.action_steps || test.action_steps.length <= 0) {
    //             return false;
    //         }
    //         return true;
    //     });
    // });
    // // 5. remove the tdata if the tests of it is empty
    var tdatas = $.grep(tdatas, function(tdata, i) {
        // console.log(n.tests);
        if (!tdata.tests || tdata.tests.length <= 0) {
            return false;
        }
        return true;
    });
    // console.log("searchAndFilter 3");
    // reload with the filtered data
    displayResultTable(tdatas);
    displayRadioButtonStyle(btn);
}

function compareColumn(value, from, to, primer) {
    console.log(value + ":" + from + ":" + to);
    if (!from && !to) {
        console.log("!from && !to");
        return true;
    }
    if (!value) {
        console.log("!value");
        return false;
    }
    // trans value if need
    var v = primer ? function(x) {return primer(x)} : function(x) {return x};
    value = v(value);
    from = v(from);
    to = v(to);
    if (from && to) {
        if (value >= from && value <= to) {
            // console.log("value >= from && value <= to");
            return true;
        }
    } else if (from) {
        if (value >= from) {
            // console.log("value >= from");
            return true;
        }
    } else if (to) {
        if (value <= to) {
            // console.log("value <= to");
            return true;
        }
    }
    // console.log("final default");
    return false;
}
function compareColumnLike(value, like) {
    if (!like) {
        return true;
    }
    if (!value) {
        return false;
    }
    if (value.search(like) != -1) {
        return true;
    } else {
        return false;
    }
}

var sortAvgResTime = false;
var sortThroughout = false;
var sortSCounts = false;
var sortTestName = false;
var sortActionName = false;

// reference from https://stackoverflow.com/questions/979256/sorting-an-array-of-javascript-objects
/**
 * sortting function
 * @param {string} field 
 * @param {boolean} reverse 
 * @param {function} primer 
 */
function sort_by(field, reverse, primer) {
    var key = primer ? 
        function(x) {return primer(x[field])} : 
        function(x) {return x[field]};

    reverse = !reverse ? 1 : -1;

    return function (a, b) {
        return a = key(a), b = key(b), reverse * ((a > b) - (b > a));
    } 
}

/**
 * 
 * @param {column name in test JSON object} column 
 * @param {true or false} sortFlag 
 * @param {parse function ex:parseFloat} parseFunc 
 */
function sortByColumn(column, sortFlag, parseFunc) {
    _tdatas.forEach(function(tdata) {
        tdata.tests.forEach(function(test) {
            test.action_steps.sort(sort_by(column, sortFlag, parseFunc));
        });
    });
}

/**
 * sortting data by different button.
 * @param {DOM element} span 
 */
function sortData(span) {
    var span = $(span);
    var id = span.attr("id");
    // console.log(typeof _tdatas);
    if (id == "btnSortAvgResTime") {
        sortAvgResTime = !sortAvgResTime;
        // console.log("sortAvgResTime=" + sortAvgResTime);
        sortByColumn('avg_res_time', sortAvgResTime, parseFloat);
    } else if (id == "btnSortThroughout") {
        sortThroughout = !sortThroughout;
        // console.log("sortThroughout=" + sortThroughout);
        sortByColumn('avg_res_time', sortAvgResTime, parseFloat);
    } else if (id == "btnSortSCounts") {
        sortSCounts = !sortSCounts;
        // console.log("sortSCounts=" + sortSCounts);
        sortByColumn('s_counts', sortSCounts, parseFloat);
    } else if (id == "btnSortActionName") {
        sortActionName = !sortActionName;
        // console.log("sortActionName=" + sortActionName);
        sortByColumn('action_name', sortActionName, null);
    } else if (id == "btnSortTestName") {
        sortTestName = !sortTestName;
        // console.log("sortSCounts=" + sortSCounts);
        _tdatas.forEach(function(tdata) {
            tdata.tests.sort(sort_by('test_name', sortTestName, null));
        });
    } else {
        console.log("WARN: span[" + id + "] invalid!");
    }
    displayResultTable(_tdatas);
}

/**
 * Expand or Collapse on textarea.
 * @param {text area element} tarea 
 * @param {tid} tid 
 */
function toggleNote(tarea, tid) {
    tarea = $(tarea);
    var rows = tarea.attr("rows");
    if (rows == maxTextareaRows) {
        tarea.attr("rows", minTextareaRows);
    } else {
        tarea.attr("rows", maxTextareaRows);
    }
}

/**
 * Collect all notes data to JSON obejct.
 */
function collectNotes() {
    var tnotes = [];
    $("textarea[id^='tar_'").each(function (i) {
        var tnote = $(this);
        tnotes[i] = {"id": tnote.attr("id").substr(4), "type": tnote.data("type"), "note": tnote.val()};
    });
    console.log(tnotes);
    return tnotes;
}

/**
 * Collect all test name to JSON object.
 */
function collectTestName() {
    var tnames = [];
    $("input[id^='tna_'").each(function (i) {
        var tname = $(this);
        tnames[i] = {"id": tname.attr("id").substr(4), "test_name": tname.val()};
    });
    console.log(tnames);
    return tnames;
}

/**
 * Collect all data that need to be delete.
 */
function collectDeleteData() {
    var deleteData = [];
    $("input[name=deleteTid]:checked").each(function(i) {
        var input = $(this);
        var value = input.attr("value");
        deleteData[i] = {"id": value};
        console.log("delete:" + value);
    });
    console.log(deleteData)
    return deleteData;
}

/**
 * Export current table to excel and remove all columns have export-remove class.
 */
function exportToExcel() {
    var table = $('#analysisTable').clone();
    // var table = $('#analysisTable');
    // console.log(table.find("input"));
    table.find("input[id^=tna]").each(function(index) {
        var input = $(this);
        var value = input.attr("value");
        input.parent().text(value);
        input.remove();
        console.log( index + ": " + value);
    });
    table.find(".export-remove").remove();
    table.find("thead tr td").each(function(index) {
        var td = $(this);
        td.text(td.text().replace("<br>", ""));
    });
    var htmls = $('<div>').append(table).html();
    var uri = 'data:application/vnd.ms-excel;base64,';
    // var template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>'; 
    var template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body>{table}</body></html>'; 
    var base64 = function(s) {
        return window.btoa(unescape(encodeURIComponent(s)));
    };

    var format = function(s, c) {
        return s.replace(/{(\w+)}/g, function(m, p) {
            return c[p];
        })
    };

    var ctx = {
        worksheet : 'Worksheet',
        table : htmls
    }

    var link = document.createElement("a");
    link.download = "export.xls";
    link.href = uri + base64(format(template, ctx));
    link.click();
}


var all_action_step_name = "所有動作";
/**
 * Wise search
 * @param {button element} btn 
 */
function btnWiseClick(btn) {
    var btn = $(btn);
    var btnId = btn.attr("id");
    var tdatas = JSON.parse(JSON.stringify(retriveTdatas()));
    if (btnId == "btnScd") {//Server Crash Detec
        var fRate = $("#scdFRate").val();
        var hit = $("#scdHit").val();
        var avgResTime = $("#scdAvgResTime").val();
        console.log("fRate:" + fRate + " hit:" + hit + " avgResTime:" + avgResTime);
        tdatas.forEach(function(tdata) {
            // tdata.tests.forEach(function(test) {
            tdata.tests = $.grep(tdata.tests, function(test) {
                var beforeSize = test.action_steps.length;
                var temp_action_steps = $.grep(test.action_steps, function(action_step) {
                    if (action_step.action_name == all_action_step_name) {
                        return compareColumn(action_step.f_rate, fRate, null, parseFloat) ||
                            compareColumn(action_step.hit, 0, hit, parseFloat) ||
                            compareColumn(action_step.avg_res_time, avgResTime, null, parseFloat);
                    }
                    return true;
                });
                var afterSize = temp_action_steps.length;
                console.log("beforeSize:" + beforeSize + " afterSize:" + afterSize);
                return beforeSize == afterSize;
            });
        });
        // 2. filter test name on second level
        tdatas = $.grep(tdatas, function(tdata) {
            // console.log(n.tests);
            if (!tdata.tests || tdata.tests.length <= 0) {
                return false;
            }
            return true;
        });
        displayResultTable(tdatas);
    } else if (btnId == "btnBart") {//The Best Avg. Response Time
        var testName = $("#bartTestName").val();
        var avgResTime = $("#bartAvgResTime").val();
        console.log("testName:" + testName + " avgResTime:" + avgResTime);
        // max vuser and min avg resp 基本值，最佳值，極限值 (vuser, avg resp)
        // map[vuser : [{id, test_name, vuser, avg_res_time}] each vuser and its' JSON object array
        var bestMap = new Map();
        tdatas.forEach(function(tdata) {
            // tdata.tests.forEach(function(test) {
            tdata.tests = $.grep(tdata.tests, function(test) {
                return compareColumnLike(test.test_name, testName);
            });
            // var bests = [];
            // var i = 0;
            tdata.tests.forEach(function(test) {
                test.action_steps.forEach(function(action_step) {
                    if (action_step.action_name == all_action_step_name) {
                        // bests[i] = {"id":test.id, "test_name":test.test_name, "vuser":test.vuser, "avg_res_time":action_step.avg_res_time};
                        // i++;
                        if (bestMap.get(test.vuser) == undefined) {
                            bestMap.set(test.vuser, []);
                        }
                        bestMap.get(test.vuser).push({"id":test.id, "test_name":test.test_name, "vuser":test.vuser, "avg_res_time":action_step.avg_res_time});
                    }
                });
            });
        });
        var minVuser = Number.MAX_SAFE_INTEGER;
        var maxVuser = 0;
        var maxAvgResTime = avgResTime;
        var limitVuser = 0;
        var baseline;
        var best;
        var limit = Number.MAX_VALUE;
        var vusers = [];
        for (let vuser of bestMap.keys()) {
            vusers.push(vuser);
        }
        vusers.sort(function(a, b){
            return a - b;
        });
        console.log(vusers);
        console.log(bestMap);
        // compare each vuser and its' data
        for (let vuser of vusers) {
            console.log(vuser);
            var datas = bestMap.get(vuser);
            console.log(datas);
            console.log(vuser + ":" + datas.length);
            datas.sort(sort_by('avg_res_time', false, parseFloat));
            datas.forEach(function(d, i) {
                console.log(i + "->" + d.avg_res_time);
            });
            vuser = parseInt(vuser);
            var data = datas[0];
            if (vuser < minVuser) {
                minVuser = vuser;
                baseline = data;
            }
            if (vuser >= maxVuser && data.avg_res_time <= maxAvgResTime) {
                maxVuser = vuser;
                // maxAvgResTime = data.avg_res_time;
                best = data;
            }
            console.log("vuser:" + vuser + " limitVuser:" + limitVuser + " maxVuser:" + maxVuser + " avg_res_time:" + data.avg_res_time);
            if (vuser > maxVuser && data.avg_res_time > maxAvgResTime && data.avg_res_time < limit) {
                limitVuser = vuser;
                limit = data;
                console.log("---- set limit");
            }
        };
        if (best == undefined) {
            best = baseline;
        }
        if (limit == undefined) {
            limit = best;
        }
        console.log("baseline: id:" + baseline.id + " vuser:" + baseline.vuser + " avg_res_time:" + baseline.avg_res_time);
        console.log("best: id:" + best.id + " vuser:" + best.vuser + " avg_res_time:" + best.avg_res_time);
        console.log("limit: id:" + limit.id + " vuser:" + limit.vuser + " avg_res_time:" + limit.avg_res_time);
        displayBestResultCell("baseline", baseline.id, baseline.vuser, baseline.avg_res_time);
        displayBestResultCell("best", best.id, best.vuser, best.avg_res_time);
        displayBestResultCell("limit", limit.id, limit.vuser, limit.avg_res_time);

    } else if (btnId == "btnPav") {//問題分析
        var fRate = $("#pavFRate").val();
        var avgResTime = $("#pavAvgResTime").val();
        var throughput = $("#pavThroughput").val();
        console.log("fRate:" + fRate + " avgResTime:" + avgResTime + " throughput:" + throughput);
        tdatas.forEach(function(tdata) {
            // tdata.tests.forEach(function(test) {
            tdata.tests = $.grep(tdata.tests, function(test) {
                var beforeSize = test.action_steps.length;
                var temp_action_steps = $.grep(test.action_steps, function(action_step) {
                    if (action_step.action_name == all_action_step_name) {
                        return compareColumn(action_step.f_rate, fRate, null, parseFloat) ||
                            compareColumn(action_step.avg_res_time, avgResTime, null, parseFloat) ||
                            compareColumn(action_step.throughput, 0, throughput, parseFloat);
                    }
                    return true;
                });
                var afterSize = temp_action_steps.length;
                console.log("beforeSize:" + beforeSize + " afterSize:" + afterSize);
                return beforeSize == afterSize;
            });
        });
        // 2. filter test name on second level
        tdatas = $.grep(tdatas, function(tdata) {
            // console.log(n.tests);
            if (!tdata.tests || tdata.tests.length <= 0) {
                return false;
            }
            return true;
        });
        displayResultTable(tdatas);
    } else {
        // no support btn
        consoloe.log("wrong btn:" + btnId)
    }
    displayRadioButtonStyle(btn);
    // $("button[name=btnWise]").each(function() {
    //     var button = $(this);
    //     if (btnId != button.attr("id")) {
    //         button.attr("class", "btn btn-default");
    //     } else {
    //         button.attr("class", "btn btn-danger");
    //     }
    // });
}

function displayRadioButtonStyle(btn) {
    var btnId = $(btn).attr("id");
    $("button[name=btnWise]").each(function() {
        var button = $(this);
        if (btnId != button.attr("id")) {
            button.attr("class", "btn btn-default");
        } else {
            button.attr("class", "btn btn-danger");
        }
    });
}

/**
 * Display best result cell on panel.
 * @param {string} resultType 
 * @param {string tid} bestResultId 
 * @param {vuser} vuser 
 * @param {avg res time} avgResTime 
 */
function displayBestResultCell(resultType, bestResultId, vuser, avgResTime) {
    var resultTypeButton = resultType + "Button";
    var resultTypeVuser = resultType + "Vuser";
    var resultTypeAvgResTime = resultType + "AvgResTime";
    $("#" + resultTypeButton).attr("onclick", "displayBestResult('" + bestResultId + "')");
    $("#" + resultTypeVuser).text(vuser);
    $("#" + resultTypeAvgResTime).text(avgResTime);
}

/**
 * Filter test by tid and display it on table.
 * @param {string tid} bestResultId 
 */
function displayBestResult(bestResultId) {
    console.log("displayBestResult:" + bestResultId);
    var tdatas = JSON.parse(JSON.stringify(retriveTdatas()));
    tdatas.forEach(function(tdata) {
        tdata.tests = $.grep(tdata.tests, function(test) {
            return test.id == bestResultId;
        });
    });
    
    tdatas = $.grep(tdatas, function(tdata) {
        console.log(tdata.tests);
        if (!tdata.tests || tdata.tests.length <= 0) {
            return false;
        }
        return true;
    });
    displayResultTable(tdatas);
}

function getDate() {
    $('#datetimepickerFrom').datetimepicker({
        format: 'YYYY/MM/DD'
    });
    $('#datetimepickerTo').datetimepicker({
        format: 'YYYY/MM/DD',
        useCurrent: false //Important! See issue #1075
    });
    $("#datetimepickerFrom").on("dp.change", function (e) {
        $('#datetimepickerTo').data("DateTimePicker").minDate(e.date);
    });
    $("#datetimepickerTo").on("dp.change", function (e) {
        $('#datetimepickerFrom').data("DateTimePicker").maxDate(e.date);
    });
}

function refreshTooltip() {
    $('[data-toggle="tooltip"]').tooltip(); 
}

function pageOnLoad() {
    getDate();
    refreshTooltip();
    // loadTestNames();
    // console.log("pageOnLoad()");
    // console.log(_result);
    // allData();
    // loadResultTable();
//    $("#btnAllData").click();
}

// {{ProjectName}} {{VerifyTable}} {{PerformanceTable}}

// --------------- no use ---------------
// var attrs = ['tdatas', 'tests'];
var attrs = ["tests", "action_steps"];
// var attrs = ["tests"];
var forceOneAry = ["action_steps"];

/**
 * 計算一筆資料需要幾個row
 * @param obj current target object
 * @param attrs all level attributes
 * @param idx current index of attrs
 * @param forceOneAry force one attributes array
 **/
function calDisplayRowSpan(obj, attrs, idx, forceOneAry) {
    if (obj == undefined) {
        return 0;
    }
    var isLast = idx == attrs.length - 1;
    var attr = attrs[idx];
    if (attr in obj) {
        // console.log("[" + idx + "] attr:" + attr + " in attrs++++++" + isLast);
        if (forceOneAry.indexOf(attr) > -1) {
            // console.log(attr + " in forceOneAry");
            return 2; // parent + child(force one) = 2
        }

        var subObj = obj[attr];
        var type = jQuery.type(subObj);
        if (type == "array") {
            // console.log("[" + idx + "] is array.");
            if (isLast) {
                // console.log(">>>>> last size:" + subObj.length);
                return subObj.length;
            } else {
                ary = subObj;
                var total = 0;
                var leng = ary.length;
                // console.log("ary.length:" + leng);
                for (var i = 0; i < leng; i++) {
                    // console.log("call [" + i + "] attr:" + attrs[idx + 1] + " " + ary[i].action_name);
                    total += calDisplayRowSpan(ary[i], attrs, idx + 1, forceOneAry);
                    // console.log("----------- total size:" + total);
                }
                // console.log(">>>>> total size:" + total);
                return total;
            }
        } else if (type == "object") {
            // console.log("[" + idx + "] is object.");
            if (isLast) {
                return 1;
            } else {
                return calDisplayRowSpan(subObj, attrs, idx + 1, forceOneAry);
            }
        } else {
            // console.log("[" + idx + "] is others:" + type);
        }
    } else {
        // console.log("[" + idx + "] attr:" + attr + " not in attrs!!!!!!");
    }
    // console.log("test[" + test["test_id"] + "]" + totalSize);
    return 0;
}

function loadTestNames(result) {
    if (result == undefined) {
        result = testnameresult;
    }
    var tests = result["tests"];
    var bartTestName = $("#bartTestName");

    for (var i = 0; i < tests.length; i++) {
        var test = tests[i];
        bartTestName.append(new Option(test["test_name"], test["test_name"]));
    }
}

function toggleActionSteps(span, tid) {
    var row = span;
    if (!(row instanceof jQuery)) {
        var tdl_id = "tdl_" + tid;
        row = $("#" + tdl_id);
    }
    // var row = $("#" + action_steps_id);
    row.toggle();
    span = $(span);
    tarea_id = "tar_" + tid;
    tarea = $('textarea[id*="' + tarea_id + '"]');
    if (row.is(":visible")) {
        span.attr("class", "glyphicon glyphicon-resize-small");
        tarea.attr("rows", maxTextareaRows);
    } else {
        span.attr("class", "glyphicon glyphicon-resize-full");
        tarea.attr("rows", minTextareaRows);
    }
}

function toggleAllActionSteps(span) {
    var span = $(span);
    var actionStepHide = span.data("actionstephide");
    // console.log("actionStepHide:" + actionStepHide);
    var btn_class = "glyphicon glyphicon-resize-small";
    var next_actionstephide = false;
    if (actionStepHide == false) {
        btn_class = "glyphicon glyphicon-resize-full";
        next_actionstephide = true;
    }

    if (actionStepHide == true) {
        $("td[id^='tdl_']").show();
        $("textarea[id^='tar_']").attr("rows", maxTextareaRows);
    } else {
        $("td[id^='tdl_']").hide();
        $("textarea[id^='tar_']").attr("rows", minTextareaRows);
    }
    $("span[id^='btn_']").attr("class", btn_class);
    span.data("actionstephide", next_actionstephide);
    span.attr("class", btn_class);
}